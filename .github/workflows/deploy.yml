name: Deploy to AWS EC2

on:
  push:
    branches: [ "main" ]

  workflow_dispatch:
    inputs:
      dry_run:
        description: "If true, run build & push images only (NO deploy to EC2)"
        required: true
        default: "false"
        type: choice
        options:
          - "false"
          - "true"

env:
  AWS_REGION: ${{ secrets.AWS_REGION }}
  AWS_ACCOUNT_ID: ${{ secrets.AWS_ACCOUNT_ID }}
  FRONTEND_ECR_REPO: ${{ secrets.FRONTEND_ECR_REPO }}
  BACKEND_ECR_REPO: ${{ secrets.BACKEND_ECR_REPO }}

jobs:
  # ======================================================
  # 1) Build and test
  # ======================================================
  build-and-test:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Show repo contents
        run: ls -R

  # ======================================================
  # 2) Build and push Docker images to ECR
  # ======================================================
  build-and-push-images:
    runs-on: ubuntu-latest
    needs: build-and-test

    outputs:
      image_tag: ${{ steps.meta.outputs.image_tag }}
      backend_image: ${{ steps.meta.outputs.backend_image }}
      frontend_image: ${{ steps.meta.outputs.frontend_image }}

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Configure AWS credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
          aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          aws-region: ${{ secrets.AWS_REGION }}

      - name: Login to Amazon ECR
        id: login-ecr
        uses: aws-actions/amazon-ecr-login@v2

      - name: Compute image metadata
        id: meta
        run: |
          IMAGE_TAG=${GITHUB_SHA::7}
          REGISTRY="${AWS_ACCOUNT_ID}.dkr.ecr.${AWS_REGION}.amazonaws.com"

          BACKEND_IMAGE="$REGISTRY/${BACKEND_ECR_REPO}:$IMAGE_TAG"
          FRONTEND_IMAGE="$REGISTRY/${FRONTEND_ECR_REPO}:$IMAGE_TAG"

          echo "image_tag=$IMAGE_TAG" >> "$GITHUB_OUTPUT"
          echo "backend_image=$BACKEND_IMAGE" >> "$GITHUB_OUTPUT"
          echo "frontend_image=$FRONTEND_IMAGE" >> "$GITHUB_OUTPUT"

      - name: Build and push backend image
        run: |
          echo "Building backend image: ${{ steps.meta.outputs.backend_image }}"
          docker build -t "${{ steps.meta.outputs.backend_image }}" ./backend
          docker push "${{ steps.meta.outputs.backend_image }}"

      - name: Build and push frontend image
        run: |
          echo "Building frontend image: ${{ steps.meta.outputs.frontend_image }}"
          docker build -t "${{ steps.meta.outputs.frontend_image }}" ./frontend
          docker push "${{ steps.meta.outputs.frontend_image }}"

  # ======================================================
  # 3) Deploy to EC2 (skipped when dry_run == "true")
  # ======================================================
  deploy-on-ec2:
    runs-on: ubuntu-latest
    needs: build-and-push-images

    # On push -> always deploy
    # On manual run -> deploy only when dry_run == "false"
    if: github.event_name == 'push' || github.event.inputs.dry_run == 'false'

    env:
      IMAGE_TAG: ${{ needs.build-and-push-images.outputs.image_tag }}
      BACKEND_IMAGE: ${{ needs.build-and-push-images.outputs.backend_image }}
      FRONTEND_IMAGE: ${{ needs.build-and-push-images.outputs.frontend_image }}
      AWS_REGION: ${{ secrets.AWS_REGION }}
      AWS_ACCOUNT_ID: ${{ secrets.AWS_ACCOUNT_ID }}

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup SSH
        uses: webfactory/ssh-agent@v0.9.0
        with:
          ssh-private-key: ${{ secrets.SSH_PRIVATE_KEY }}

      - name: Add EC2 host to known_hosts
        run: ssh-keyscan -H ${{ secrets.EC2_HOST }} >> ~/.ssh/known_hosts

      - name: Ensure deploy dir exists and copy docker-compose
        run: |
          ssh ubuntu@${{ secrets.EC2_HOST }} "sudo mkdir -p /opt/app && sudo chown ubuntu:ubuntu /opt/app"
          scp docker-compose.yml ubuntu@${{ secrets.EC2_HOST }}:/opt/app/docker-compose.yml

      - name: Deploy on EC2
        run: |
          REGISTRY="${AWS_ACCOUNT_ID}.dkr.ecr.${AWS_REGION}.amazonaws.com"

          ssh ubuntu@${{ secrets.EC2_HOST }} "set -e
            export BACKEND_IMAGE=${BACKEND_IMAGE}
            export FRONTEND_IMAGE=${FRONTEND_IMAGE}
            export IMAGE_TAG=${IMAGE_TAG}
            export AWS_REGION=${AWS_REGION}
            export REGISTRY=${REGISTRY}

            cd /opt/app

            aws ecr get-login-password --region \${AWS_REGION} \
              | docker login --username AWS --password-stdin \${REGISTRY}

            if [ -f last_successful_tag.txt ]; then
              mv last_successful_tag.txt previous_successful_tag.txt
            fi

            echo \"Deploying backend:  \${BACKEND_IMAGE}\"
            echo \"Deploying frontend: \${FRONTEND_IMAGE}\"

            BACKEND_IMAGE=\${BACKEND_IMAGE} FRONTEND_IMAGE=\${FRONTEND_IMAGE} docker-compose pull
            BACKEND_IMAGE=\${BACKEND_IMAGE} FRONTEND_IMAGE=\${FRONTEND_IMAGE} docker-compose down || true
            BACKEND_IMAGE=\${BACKEND_IMAGE} FRONTEND_IMAGE=\${FRONTEND_IMAGE} docker-compose up -d

            echo \"\${IMAGE_TAG}\" > last_successful_tag.txt
          "

  # ======================================================
  # 4) Dry-run summary (only when deploy is skipped)
  # ======================================================
  dry-run-summary:
    runs-on: ubuntu-latest
    needs: build-and-push-images
    if: github.event_name == 'workflow_dispatch' && github.event.inputs.dry_run == 'true'

    steps:
      - name: Print dry run info
        run: |
          echo "Dry run completed."
          echo "Images built & pushed, but NO deployment to EC2 was performed."
          echo "Tag: ${{ needs.build-and-push-images.outputs.image_tag }}"
          echo "Backend image:  ${{ needs.build-and-push-images.outputs.backend_image }}"
          echo "Frontend image: ${{ needs.build-and-push-images.outputs.frontend_image }}"
