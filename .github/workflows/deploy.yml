name: Deploy to AWS EC2

on:
  push:
    branches: [ "main" ]
  workflow_dispatch:

env:
  AWS_REGION: ${{ secrets.AWS_REGION }}
  AWS_ACCOUNT_ID: ${{ secrets.AWS_ACCOUNT_ID }}
  FRONTEND_ECR_REPO: ${{ secrets.FRONTEND_ECR_REPO }}
  BACKEND_ECR_REPO: ${{ secrets.BACKEND_ECR_REPO }}

# ============================================================
# 1) Build & (optional) test stage
# ============================================================
jobs:
  build-and-test:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      # ---- Optional backend sanity check ----
      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.12"

      - name: Backend check (optional)
        working-directory: backend
        run: |
          python -m pip install -r requirements.txt
          # Basic Django sanity check; uncomment tests when you add them
          python manage.py check
          # python manage.py test

      # ---- Optional frontend sanity build ----
      - name: Setup Node
        uses: actions/setup-node@v4
        with:
          node-version: "20"

      - name: Frontend build (optional)
        working-directory: frontend
        run: |
          npm ci
          npm run build

  # ============================================================
  # 2) Build & push images to ECR
  # ============================================================
  build-and-push-images:
    runs-on: ubuntu-latest
    needs: build-and-test

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Configure AWS credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
          aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          aws-region: ${{ secrets.AWS_REGION }}

      - name: Login to Amazon ECR
        id: login-ecr
        uses: aws-actions/amazon-ecr-login@v2

      - name: Build and push backend image
        run: |
          IMAGE_TAG=${GITHUB_SHA::7}
          REGISTRY="${{ steps.login-ecr.outputs.registry }}"
          BACKEND_IMAGE="${REGISTRY}/${BACKEND_ECR_REPO}:${IMAGE_TAG}"

          echo "Building backend image: ${BACKEND_IMAGE}"

          docker build -t "${BACKEND_IMAGE}" ./backend
          # optional latest tag:
          docker tag "${BACKEND_IMAGE}" "${REGISTRY}/${BACKEND_ECR_REPO}:latest"

          docker push "${BACKEND_IMAGE}"
          docker push "${REGISTRY}/${BACKEND_ECR_REPO}:latest"

      - name: Build and push frontend image
        run: |
          IMAGE_TAG=${GITHUB_SHA::7}
          REGISTRY="${{ steps.login-ecr.outputs.registry }}"
          FRONTEND_IMAGE="${REGISTRY}/${FRONTEND_ECR_REPO}:${IMAGE_TAG}"

          echo "Building frontend image: ${FRONTEND_IMAGE}"

          docker build -t "${FRONTEND_IMAGE}" ./frontend
          # optional latest tag:
          docker tag "${FRONTEND_IMAGE}" "${REGISTRY}/${FRONTEND_ECR_REPO}:latest"

          docker push "${FRONTEND_IMAGE}"
          docker push "${REGISTRY}/${FRONTEND_ECR_REPO}:latest"

  # ============================================================
  # 3) Deploy to EC2 using docker-compose
  #    Also maintain last/previous successful tags for rollback
  # ============================================================
  deploy-on-ec2:
    runs-on: ubuntu-latest
    needs: build-and-push-images

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup SSH agent
        uses: webfactory/ssh-agent@v0.9.0
        with:
          ssh-private-key: ${{ secrets.SSH_PRIVATE_KEY }}

      - name: Add EC2 host to known_hosts
        run: ssh-keyscan -H ${{ secrets.EC2_HOST }} >> ~/.ssh/known_hosts

      - name: Ensure deploy dir exists and copy docker-compose
        run: |
          ssh ubuntu@${{ secrets.EC2_HOST }} "sudo mkdir -p /opt/app && sudo chown ubuntu:ubuntu /opt/app"
          scp docker-compose.yml ubuntu@${{ secrets.EC2_HOST }}:/opt/app/docker-compose.yml

      - name: Deploy on EC2
        env:
          AWS_REGION: ${{ secrets.AWS_REGION }}
          AWS_ACCOUNT_ID: ${{ secrets.AWS_ACCOUNT_ID }}
        run: |
          # Build image names using the same short SHA tag
          IMAGE_TAG=${GITHUB_SHA::7}
          REGISTRY="${AWS_ACCOUNT_ID}.dkr.ecr.${AWS_REGION}.amazonaws.com"
          BACKEND_IMAGE="${REGISTRY}/${BACKEND_ECR_REPO}:${IMAGE_TAG}"
          FRONTEND_IMAGE="${REGISTRY}/${FRONTEND_ECR_REPO}:${IMAGE_TAG}"

          echo "Deploying tag: ${IMAGE_TAG}"
          echo "Backend image:  ${BACKEND_IMAGE}"
          echo "Frontend image: ${FRONTEND_IMAGE}"

          ssh ubuntu@${{ secrets.EC2_HOST }} "
            set -e

            cd /opt/app

            export AWS_REGION=${AWS_REGION}
            export REGISTRY=${REGISTRY}
            export BACKEND_IMAGE=${BACKEND_IMAGE}
            export FRONTEND_IMAGE=${FRONTEND_IMAGE}
            export IMAGE_TAG=${IMAGE_TAG}

            # Log in to ECR from EC2 instance
            aws ecr get-login-password --region \${AWS_REGION} \
              | docker login --username AWS --password-stdin \${REGISTRY}

            # Track last and previous successful tags for rollback
            if [ -f last_successful_tag.txt ]; then
              mv last_successful_tag.txt previous_successful_tag.txt
            fi

            echo \"Deploying backend:  \${BACKEND_IMAGE}\"
            echo \"Deploying frontend: \${FRONTEND_IMAGE}\"

            BACKEND_IMAGE=\${BACKEND_IMAGE} FRONTEND_IMAGE=\${FRONTEND_IMAGE} docker-compose pull
            BACKEND_IMAGE=\${BACKEND_IMAGE} FRONTEND_IMAGE=\${FRONTEND_IMAGE} docker-compose down || true
            BACKEND_IMAGE=\${BACKEND_IMAGE} FRONTEND_IMAGE=\${FRONTEND_IMAGE} docker-compose up -d

            echo \"\${IMAGE_TAG}\" > last_successful_tag.txt
          "
