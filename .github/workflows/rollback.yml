name: Rollback to previous version

on:
  workflow_dispatch:
    inputs:
      confirm:
        description: "Type ROLLBACK to confirm rollback to previous_successful_tag.txt"
        required: true
        default: "CANCEL"

env:
  AWS_REGION: ${{ secrets.AWS_REGION }}
  AWS_ACCOUNT_ID: ${{ secrets.AWS_ACCOUNT_ID }}
  FRONTEND_ECR_REPO: ${{ secrets.FRONTEND_ECR_REPO }}
  BACKEND_ECR_REPO: ${{ secrets.BACKEND_ECR_REPO }}

jobs:
  # ======================================================
  # 0) Guard: require explicit confirmation
  # ======================================================
  guard:
    runs-on: ubuntu-latest
    if: ${{ github.event.inputs.confirm != 'ROLLBACK' }}

    steps:
      - name: Fail because confirmation was not ROLLBACK
        run: |
          echo "You must type exactly 'ROLLBACK' to run this workflow."
          exit 1

  # ======================================================
  # 1) Read and validate tags from EC2
  # ======================================================
  read-and-validate-tag:
    runs-on: ubuntu-latest
    needs: guard
    if: ${{ github.event.inputs.confirm == 'ROLLBACK' }}

    outputs:
      last: ${{ steps.read.outputs.last }}
      prev: ${{ steps.read.outputs.prev }}

    steps:
      - name: Setup SSH
        uses: webfactory/ssh-agent@v0.9.0
        with:
          ssh-private-key: ${{ secrets.SSH_PRIVATE_KEY }}

      - name: Add EC2 host to known_hosts
        run: ssh-keyscan -H ${{ secrets.EC2_HOST }} >> ~/.ssh/known_hosts

      - name: Read last and previous tags from EC2
        id: read
        run: |
          LAST_TAG=$(ssh ubuntu@${{ secrets.EC2_HOST }} "cd /opt/app && [ -f last_successful_tag.txt ] && cat last_successful_tag.txt || echo ''")
          PREV_TAG=$(ssh ubuntu@${{ secrets.EC2_HOST }} "cd /opt/app && [ -f previous_successful_tag.txt ] && cat previous_successful_tag.txt || echo ''")

          echo "Last deployed tag:     ${LAST_TAG}"
          echo "Previous deployed tag: ${PREV_TAG}"

          if [ -z "$PREV_TAG" ]; then
            echo 'ERROR: previous_successful_tag.txt not found or empty on server. Cannot rollback.' >&2
            exit 1
          fi

          if [ "$LAST_TAG" = "$PREV_TAG" ]; then
            echo "ERROR: last_successful_tag and previous_successful_tag are the same (${LAST_TAG}). Nothing to roll back to." >&2
            exit 1
          fi

          echo "last=${LAST_TAG}" >> $GITHUB_OUTPUT
          echo "prev=${PREV_TAG}" >> $GITHUB_OUTPUT

  # ======================================================
  # 2) Validate that backend & frontend images for that tag exist in ECR
  # ======================================================
  verify-images-exist:
    runs-on: ubuntu-latest
    needs: read-and-validate-tag

    steps:
      - name: Configure AWS credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
          aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          aws-region: ${{ secrets.AWS_REGION }}

      - name: Check images for previous tag exist in ECR
        env:
          PREV_TAG: ${{ needs.read-and-validate-tag.outputs.prev }}
        run: |
          echo "Checking ECR images for tag: ${PREV_TAG}"

          # Backend image
          aws ecr describe-images \
            --repository-name "${BACKEND_ECR_REPO}" \
            --image-ids imageTag="${PREV_TAG}" >/dev/null

          # Frontend image
          aws ecr describe-images \
            --repository-name "${FRONTEND_ECR_REPO}" \
            --image-ids imageTag="${PREV_TAG}" >/dev/null

          echo "Images for tag ${PREV_TAG} exist in ECR."

  # ======================================================
  # 3) Perform rollback on EC2
  # ======================================================
  rollback:
    runs-on: ubuntu-latest
    needs:
      - read-and-validate-tag
      - verify-images-exist

    steps:
      - name: Setup SSH
        uses: webfactory/ssh-agent@v0.9.0
        with:
          ssh-private-key: ${{ secrets.SSH_PRIVATE_KEY }}

      - name: Add EC2 host to known_hosts
        run: ssh-keyscan -H ${{ secrets.EC2_HOST }} >> ~/.ssh/known_hosts

      - name: Roll back on EC2
        env:
          PREV_TAG: ${{ needs.read-and-validate-tag.outputs.prev }}
          LAST_TAG: ${{ needs.read-and-validate-tag.outputs.last }}
        run: |
          echo "Rolling back from tag: ${LAST_TAG}"
          echo "Rolling back to tag:   ${PREV_TAG}"

          REGISTRY="${AWS_ACCOUNT_ID}.dkr.ecr.${AWS_REGION}.amazonaws.com"
          BACKEND_IMAGE="${REGISTRY}/${BACKEND_ECR_REPO}:${PREV_TAG}"
          FRONTEND_IMAGE="${REGISTRY}/${FRONTEND_ECR_REPO}:${PREV_TAG}"

          echo "Backend image:  ${BACKEND_IMAGE}"
          echo "Frontend image: ${FRONTEND_IMAGE}"

          ssh ubuntu@${{ secrets.EC2_HOST }} "
            set -e

            cd /opt/app

            export AWS_REGION=${AWS_REGION}
            export REGISTRY=${REGISTRY}
            export BACKEND_IMAGE=${BACKEND_IMAGE}
            export FRONTEND_IMAGE=${FRONTEND_IMAGE}

            # Login to ECR
            aws ecr get-login-password --region \${AWS_REGION} \
              | docker login --username AWS --password-stdin \${REGISTRY}

            echo \"Rolling back backend to:  \${BACKEND_IMAGE}\"
            echo \"Rolling back frontend to: \${FRONTEND_IMAGE}\"

            BACKEND_IMAGE=\${BACKEND_IMAGE} FRONTEND_IMAGE=\${FRONTEND_IMAGE} docker-compose pull
            BACKEND_IMAGE=\${BACKEND_IMAGE} FRONTEND_IMAGE=\${FRONTEND_IMAGE} docker-compose down || true
            BACKEND_IMAGE=\${BACKEND_IMAGE} FRONTEND_IMAGE=\${FRONTEND_IMAGE} docker-compose up -d

            # Keep track of what we rolled back from (for audit)
            if [ -f last_successful_tag.txt ]; then
              mv last_successful_tag.txt rolled_back_from_tag.txt
            fi

            echo \"${PREV_TAG}\" > last_successful_tag.txt
          "
